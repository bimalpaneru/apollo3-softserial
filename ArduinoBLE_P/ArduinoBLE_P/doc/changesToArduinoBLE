Changes Applied for ArduinoBLE_P (P from Patched)

This version of ArduinoBLE can work on Sparkfun library 2.0.x as well as Library 1.2.3
The original ArduinoBLE was version 1.3.2 now version 3.3.2



=================================
#Enable working on Sparkfun 1.2.1
=================================
New files have been added to ArduinoBLE/src/uility/

HCIExactleTransport.cpp
HCIExactleTransport.h

The handle the HCI interface between the ArduinoBLE HCI commands and
the Exactle layer.

=================================
#Handle correct detection
=================================
Depending on the architecture either UART, Cordio or EXACTLE HCI-Transport
layer is selected. This needs a small change

In HCIUartTransport.cpp around line 20
change :  #if !defined(ARDUINO_ARCH_MBED)
to     :  #if !defined(ARDUINO_ARCH_MBED) && !defined(ARDUINO_ARCH_APOLLO3)

=================================
#Added example
=================================
Added example10_ph_BME280 and example10_central_BME280. This will demonstrate
a menu structure interaction and sending the BME280 sensor data.

=============================================
# MANY different BUGS fixes applied
=============================================

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In ArduinoBLE/src/uility/HCICordioTransport.CPP fix a bug to prevent loosing data.
   In routine handleRxData() around line 294
   change :     return;
   to     :     yield();


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In ArduinoBLE/src/uility/HCICordioTransport.CPP fix a bug that will block sleep

4 changes to be applied:

   1) In global space around line 75
   ADD : volatile bool GoSleep = false;    // added {paulvha}
................................................................
   2) In routine bleLoop() around line 121
   ADD :  in the top of while (true) loop :

   while (true){

       if (GoSleep) {    // added {paulvha}
            timer.stop();
            //Serial.print("SLEEP\n");
            rtos::ThisThread::flags_wait_any(0x02); // wait for signal
            //Serial.print("WAKE\n");
            timer.start();
        }

        ........
..................................................................
   3) In routine begin() around line 209
   change  :	bleLoopThread.start(bleLoop);

   to      :
    if (GoSleep) {
      bleLoopThread.flags_set(0x02);  // restart scheduler (paulvha)
      GoSleep = false;
    }
    else
      bleLoopThread.start(bleLoop);     // start WSF sheduler
...............................................................
   4) In routine end() around line 225
   change  :    bleLoopThread.terminate();      // once terminated you can NOT restart (paulvha)
   to      :    GoSleep = true;                 // set WSF sheduler to sleep (paulvha)

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In ArduinoBLE/src/uility/HCICordioTransport.CPP fix a bug to prevent crash if no buffer can be obtained
  In routine write() around line 273

  AFTER:
    uint8_t* packet = (uint8_t*) WsfMsgAlloc(max(packetLength, MIN_WSF_ALLOC));

  ADD:
  if (packet == NULL) {
     Serial.println("HCICordioTransportClass::write");  // {paulvha}
     Serial.println("Could not obtain memory");
     return(0);
  }
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In ArduinoBLE/src/uility/HCI.CPP fix a bug to prevent uncontrolled hang during attributes

    In routine poll() around line 146
    change :

     if (_debug) {
        dumpPkt("HCI EVENT RX <- ", _recvIndex, _recvBuffer);
     }

    to :

    if (_debug) {
        dumpPkt("HCI EVENT RX <- ", _recvIndex, _recvBuffer);
    }
    else
        delay(20);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In ArduinoBLE/src/uility/HCI.CPP fix a crash after disconnect when working as Central
3 changes are needed

    1) In global space around line 73

    AFTER :
    	 #define HCI_OE_USER_ENDED_CONNECTION 0x13	
    
    ADD : 
   	 bool ScanResponseDataSet = false;

    ....................................................
    
    2) In leSetScanResponseData() around line 350
    
    AFTER : 
         memcpy(leScanResponseData.data, data, length);
 
    ADD:
      // indicate running as peripheral {paulvha}
      ScanResponseDataSet = true;
      
    ....................................................
    
    3) In handleEventPkt() around line 835
    
    CHANGE : 
         HCI.leSetAdvertiseEnable(0x01);
 
    TO :
        if (ScanResponseDataSet) HCI.leSetAdvertiseEnable(0x01);

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In ArduinoBLE/src/local/BLELocalDevice.CPP fix a bug to give time to settle after reset()

   In routine begin() around line 99
   AFTER:

    if (HCI.reset() != 0) {
     end();
     return 0;
    }

   ADD :
    delay(1000);

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In ArduinoBLE/src/local/BLELocalCharacteristic.CPP fix a bug When we use ArduinoBLE (1.1.3) as Peripheral device it notifies subscribed Central of characteristic value change, even if the write came from Central itself.
Issue :https://github.com/arduino-libraries/ArduinoBLE/issues/144

  In routine writeValue() around line 113
  AFTER :
  if (_fixedLength) {
    _valueLength = _valueSize;
  }
  
  ADD :
  if (_written) {
    return 1;
  }
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Fix a bug where disconnect needs a clean up in ATT to prevent memory leaks
3 changes to apply

1) In ArduinoBLE/src/uility/ATT.CPP around line 247
  
BEFORE:
  void ATTClass::addConnection(uint16_t handle, uint8_t role, uint8_t peerBdaddrType,
  
ADD:
// can lead to memory leaks for _peers[i].device and other issues,
// especially if disconnect does not not happen nicely
// https://github.com/arduino-libraries/ArduinoBLE/issues/129
// {paulvha}
void ATTClass::end()
{
    for (int i = 0; i < ATT_MAX_PEERS; i++) {
        if (_peers[i].connectionHandle == 0xffff) {
        continue;
        }
    
        _peers[i].connectionHandle = 0xffff;
        _peers[i].role = 0x00;
        _peers[i].addressType = 0x00;
        memset(_peers[i].address, 0x00, sizeof(_peers[i].address));
        _peers[i].mtu = 23;
        
        if (_peers[i].device) {
          delete _peers[i].device;
          _peers[i].device = NULL;
        }
    }
}

..................................................................
2) In In ArduinoBLE/src/uility/ATT.h around line 84

AFTER:
  bool disconnect();
ADD:
  void end();       // {paulvha}


..................................................................
3) In ArduinoBLE/src/local/BLELocalDevice.CPP

In void BLELocalDevice::end(), around line 188
AFTER :
  GATT.end();
  
ADD:
  ATT.end();        // {paulvha}
  

...................................................................................

In ArduinoBLE/src/uility/HCI.CPP fix issue with memory allocation warning
4 changes

1) In int HCIClass::sendAclPkt() around line 641

CHANGE:
  uint8_t txBuffer[sizeof(aclHdr) + plen];
TO:
  uint8_t* txBuffer = (uint8_t*)malloc(sizeof(aclHdr) + plen);  // issue fixed {paulvha}

...................................................................................

2) In int HCIClass::sendAclPkt() around line 658

AFTER:
  HCITransport.write(txBuffer, sizeof(aclHdr) + plen);
ADD:
  free(txbuffer);  // issue fixed {paulvha}

...................................................................................

3) In int HCIClass::sendCommand() around line 691

CHANGE:
  uint8_t txBuffer[sizeof(aclHdr) + plen];
TO:
  uint8_t* txBuffer = (uint8_t*)malloc(sizeof(pktHdr) + plen);  // issue fixed {paulvha}

...................................................................................

4) In int HCIClass::sendCommand() around line 709

AFTER:
  HCITransport.write(txBuffer, sizeof(pktHdr) + plen);
ADD:
  free(txbuffer);  // issue fixed {paulvha}

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In ArduinoBLE/src/BLEAdvertisingData.CPP fix issue with incorrect AD field setting
https://github.com/arduino-libraries/ArduinoBLE/issues/239

in function addAdvertisedServiceUuid()

change:  advField = BLEFieldIncompleteAdvertisedService128;
to advField = BLEFieldCompleteAdvertisedService128;

change:  advField = BLEFieldIncompleteAdvertisedService16;
to advField = BLEFieldCompleteAdvertisedService16;

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Fix for multiple callback on BLEread when the value that was written before is 
larger than the MTU size. 1 change


ArduinoBLE/src/local/BLELocalCharacteristic.cpp

CHANGE readValue() to :

void BLELocalCharacteristic::readValue(BLEDevice device, uint16_t offset, uint8_t value[], int length)
{
  // setting to TRUE at BEGINNING will force a call BLERead to enable overwrite the current value.  (set with a previous writeValue())
  // setting to FALSE at BEGINNING, it will first send the current value.  (set with a previous writeValue())

  // once the complete value has been send, with the following readValue() call it will
  // call BLERead to overwrite the current value. { Nov 22 paulvha}
  static bool AllWasReadBefore = true;

  // if the complete previous value was read before, allowed it to be updated
  if (AllWasReadBefore) {

     // allow call back (if set)
     if (_eventHandlers[BLERead]) {
          _eventHandlers[BLERead](device, BLECharacteristic(this));
     }

     AllWasReadBefore = false;
  }

  // copy the value
  memcpy(value, _value + offset, length);

  // check complete message has been read
  if (offset + length >= _valueLength) {
     AllWasReadBefore = true;
  }

 // Serial.print("read: ");
 // Serial.print(length);
 // Serial.print(" offset: ");
 // Serial.print(offset);
 // Serial.print(" AllWasReadBefore ");
 // Serial.println(AllWasReadBefore);
}
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
